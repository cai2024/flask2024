Building DAG of jobs...
Using shell: /usr/bin/bash
Provided cores: 20
Rules claiming more threads will be scaled down.
Job stats:
job               count
--------------  -------
all                   1
bowtie2_se            2
fastp_se              2
get_log               2
mark_duplicate        2
qualimap_bamqc        2
total                11

Select jobs to execute...
Execute 2 jobs...

[Fri May 10 15:48:09 2024]
localrule fastp_se:
    input: /data/cailab/temp/fastq/1w_2.fq.gz
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/trim_1w_2_single.fq.gz, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/1w_2_single.json, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/1w_2_single.html
    log: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/logs/fastp/1w_2.log
    jobid: 4
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/trim_1w_2_single.fq.gz, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/1w_2_single.json
    wildcards: sample=1w_2
    threads: 2
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

Activating conda environment: flask2024

[Fri May 10 15:48:20 2024]
localrule fastp_se:
    input: /data/cailab/temp/fastq/1w_1.fq.gz
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/trim_1w_1_single.fq.gz, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/1w_1_single.json, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/1w_1_single.html
    log: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/logs/fastp/1w_1.log
    jobid: 2
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/trim_1w_1_single.fq.gz, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/1w_1_single.json
    wildcards: sample=1w_1
    threads: 2
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

Activating conda environment: flask2024
[Fri May 10 15:48:49 2024]
Finished job 4.
1 of 11 steps (9%) done
Select jobs to execute...
Execute 1 jobs...

[Fri May 10 15:48:49 2024]
localrule bowtie2_se:
    input: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/trim_1w_2_single.fq.gz
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_2_single.bam
    log: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/logs/bowtie2/1w_2.log
    jobid: 3
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_2_single.bam; Input files updated by another job: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/trim_1w_2_single.fq.gz
    wildcards: sample=1w_2
    threads: 10
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

[Fri May 10 15:48:49 2024]
Finished job 2.
2 of 11 steps (18%) done
Select jobs to execute...
Execute 1 jobs...

[Fri May 10 15:48:49 2024]
localrule bowtie2_se:
    input: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/trim_1w_1_single.fq.gz
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_1_single.bam
    log: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/logs/bowtie2/1w_1.log
    jobid: 1
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_1_single.bam; Input files updated by another job: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/trim_1w_1_single.fq.gz
    wildcards: sample=1w_1
    threads: 10
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

[Fri May 10 15:49:01 2024]
Finished job 3.
3 of 11 steps (27%) done
Select jobs to execute...
Execute 1 jobs...

[Fri May 10 15:49:01 2024]
localrule mark_duplicate:
    input: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_2_single.bam
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_2_dedup.bam
    log: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/logs/duplication/1w_2.log
    jobid: 6
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_2_dedup.bam; Input files updated by another job: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_2_single.bam
    wildcards: sample=1w_2
    threads: 4
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

[Fri May 10 15:49:01 2024]
Finished job 1.
4 of 11 steps (36%) done
Select jobs to execute...
Execute 1 jobs...

[Fri May 10 15:49:01 2024]
localrule mark_duplicate:
    input: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_1_single.bam
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_1_dedup.bam
    log: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/logs/duplication/1w_1.log
    jobid: 5
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_1_dedup.bam; Input files updated by another job: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_1_single.bam
    wildcards: sample=1w_1
    threads: 4
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

[Fri May 10 15:49:03 2024]
Finished job 5.
5 of 11 steps (45%) done
Select jobs to execute...
Execute 1 jobs...

[Fri May 10 15:49:03 2024]
localrule qualimap_bamqc:
    input: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_1_dedup.bam
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/cover/1w_1/genome_results.txt
    log: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/logs/qualimap/1w_1.log
    jobid: 7
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/cover/1w_1/genome_results.txt; Input files updated by another job: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_1_dedup.bam
    wildcards: sample=1w_1
    threads: 10
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

[Fri May 10 15:49:03 2024]
Finished job 6.
6 of 11 steps (55%) done
Select jobs to execute...
Execute 1 jobs...

[Fri May 10 15:49:03 2024]
localrule qualimap_bamqc:
    input: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_2_dedup.bam
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/cover/1w_2/genome_results.txt
    log: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/logs/qualimap/1w_2.log
    jobid: 8
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/cover/1w_2/genome_results.txt; Input files updated by another job: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_2_dedup.bam
    wildcards: sample=1w_2
    threads: 10
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

[Fri May 10 15:49:28 2024]
Finished job 8.
7 of 11 steps (64%) done
Select jobs to execute...
Execute 1 jobs...

[Fri May 10 15:49:28 2024]
localrule get_log:
    input: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/1w_2_single.json, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/cover/1w_2/genome_results.txt, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_2_single.bam, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_2_dedup.bam
    output: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/final_log/1w_2.log
    jobid: 10
    reason: Missing output files: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/final_log/1w_2.log; Input files updated by another job: /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/bam/1w_2_single.bam, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/debam/1w_2_dedup.bam, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/cover/1w_2/genome_results.txt, /data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/trim/1w_2_single.json
    wildcards: sample=1w_2
    threads: 4
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954, tmpdir=/data/cailab/flask_output/20240510154700-2b6b0e57-4c15-4124-ac60-51df4016d354/temp_test

RuleException in rule get_log in file /data/cailab/flask2024/flask_snk/WGS.py, line 140:
NameError: The name 'ref' is unknown in this context. Please make sure that you defined that variable. Also note that braces not used for variable access have to be escaped by repeating them, i.e. {{print $1}}, when formatting the following:

        name=$(echo {params.my_sample})
        raw_size=$(python3 {ref}/get_json.py {input.json} summary,before_filtering,total_bases)
        raw_read_num=$(python3 {ref}/get_json.py {input.json} summary,before_filtering,total_reads)
        dup_radio1=$(python3 {ref}/get_json.py {input.json} duplication,rate)

        clean_read_num=$(samtools view -c {input.bam}) 
        de_read_num=$(samtools view -c {input.dedup_bam})
        map_read_num=$(samtools view -c -F 4 {input.bam})
        
        cover=$(sed -n 's/.*There is a \([0-9.]*\)\% of reference with a coverageData >= 1X.*/\1/p' {input.cover})
        ref_size=$(sed -n 's/.*number of bases = \([0-9,]*\) bp.*/\1/p' {input.cover} | tr -d ',')
        map_size=$(sed -n 's/.*number of mapped bases = \([0-9,]*\) bp.*/\1/p' {input.cover} | tr -d ',')

        gc=$(python3 {ref}/get_json.py {input.json} summary,after_filtering,gc_content)
        q20=$(python3 {ref}/get_json.py {input.json} summary,after_filtering,q20_rate)
        q30=$(python3 {ref}/get_json.py {input.json} summary,after_filtering,q30_rate)
        chrm_num=$(samtools view -c {input.bam} chrM)



     
        [ "$(echo "$raw_read_num == 0" | bc)" -eq 1 ] && raw_read_num=100000000000
        [ "$(echo "$clean_read_num == 0" | bc)" -eq 1 ] && clean_read_num=100000000000
        [ "$(echo "$cover == 0" | bc)" -eq 1 ] && cover=100000000000
        [ "$(echo "$map_read_num == 0" | bc)" -eq 1 ] && map_read_num=100000000000
        ########################################
        sequence_size=$(echo "scale=4; $raw_size/1000000000" | bc)
        clean_read_ratio=$(echo "scale=4; $clean_read_num/$raw_read_num" | bc)
        duplication_rate=$(echo "scale=4; (($clean_read_num-$de_read_num)/$raw_read_num)+$dup_radio1" | bc)
        map_read_ratio=$(echo "scale=4; $map_read_num/$clean_read_num" | bc)
        average_depth=$(echo "scale=4; $map_size/($cover*$ref_size*0.01)" | bc)
        mit_ratio=$(echo "scale=4; $chrm_num/$map_read_num" | bc)

        gc_filter_ratio=$(echo "scale=4; $gc/1" | bc)
        q20_filter_ratio=$(echo "scale=4; $q20/1" | bc)
        q30_filter_ratio=$(echo "scale=4; $q30/1" | bc)


        echo -e "name	sequence_size	clean_read_ratio	duplication_rate	map_read_ratio	cover_ratio	average_depth	gc_filter_ratio	mit_ratio	q20_filter_ratio	q30_filter_ratio	total_reads_raw" > {output.log}

        echo -e "$name	$sequence_size	$clean_read_ratio	$duplication_rate	$map_read_ratio	$cover	$average_depth	$gc_filter_ratio	$mit_ratio	$q20_filter_ratio	$q30_filter_ratio	$raw_read_num" >> {output.log}
        
